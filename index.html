<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>可攜式連結記事簿 · GitHub Pages 版</title>
  <style>
    :root{
      --bg: #0b1220; --panel:#121a2b; --muted:#9aa1ac; --txt:#e5e7eb; --border:#1f2937; --card:#0f172a;
      --primary:#60a5fa; --danger:#f87171; --warn:#fbbf24; --chip:#0c1526;
    }
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC, Helvetica, Arial; color:var(--txt); background:#0b1220}
    header{position:sticky;top:0;background:rgba(11,18,32,.75);backdrop-filter:saturate(160%) blur(8px);border-bottom:1px solid var(--border);z-index:20}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{font-size:18px;margin:0 0 8px}
    .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .bar > *{min-height:36px}
    input, select, textarea{background:#0d1628;color:var(--txt);border:1px solid var(--border);border-radius:8px;padding:8px}
    button{background:#111a2e;color:var(--txt);border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer}
    button.primary{background:linear-gradient(180deg,#2563eb,#1d4ed8);border-color:#1d4ed8}
    button.warn{background:#3b2a0a;border-color:#5a3f11;color:#fcd34d}
    button.danger{background:#2a1111;border-color:#512020;color:#fecaca}

    .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
    .muted{color:var(--muted)}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.split{grid-template-columns:1fr}}

    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:var(--chip);font-size:12px}
    .chip .x{padding:0 6px;border-radius:8px;background:#1f2a44;border:1px solid #2a395a;cursor:pointer}

    .grid{display:grid;grid-template-columns:1.2fr .8fr .8fr auto;gap:8px;align-items:center}

    .tbl{width:100%;border-spacing:0;border-collapse:separate}
    .tbl th,.tbl td{padding:10px 8px;border-bottom:1px solid var(--border);vertical-align:top}
    .tbl th{position:sticky;top:86px;background:rgba(15,23,42,.9);backdrop-filter:blur(6px);text-align:left;z-index:5}
    .row{background:var(--card)}
    .tools{display:flex;gap:6px;flex-wrap:wrap}
    .link{color:#a5b4fc;text-decoration:none}

    dialog{border:none;border-radius:16px;padding:0;background:#0b1220;color:var(--txt);box-shadow:0 30px 80px rgba(0,0,0,.5);max-width:640px}
    dialog::backdrop{background:rgba(0,0,0,.5)}
    .modal{padding:16px;border:1px solid var(--border)}
    .modal header{position:sticky;top:0;background:#0b1220;border-bottom:1px solid var(--border);padding:12px 16px}
    .modal .body{padding:16px}
    .flex{display:flex;gap:8px;align-items:center}
    .right{margin-left:auto}
    .sep{height:1px;background:var(--border);margin:8px 0}
    .kbd{font:12px/1.2 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#0c1424;padding:2px 6px;border-radius:6px;border:1px solid #182033}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>🔖 可攜式連結記事簿 <span class="muted">· 單檔（GitHub 同步 / UTF‑8 OK）</span></h1>
      <div class="bar">
        <input id="q" placeholder="搜尋：描述 / 連結 / 類型 關鍵字" class="grow" style="flex:1 1 280px" />
        <select id="filterType"></select>
        <select id="sorter">
          <option value="updatedAt_desc">更新時間 ⬇︎</option>
          <option value="updatedAt_asc">更新時間 ⬆︎</option>
          <option value="createdAt_desc">建立時間 ⬇︎</option>
          <option value="createdAt_asc">建立時間 ⬆︎</option>
          <option value="type_asc">類型 A→Z</option>
        </select>
        <button id="btnExport">匯出 JSON</button>
        <input id="fileImport" type="file" accept="application/json" style="display:none" />
        <button id="btnImport" class="warn">匯入 JSON</button>
        <button id="btnLoadGH" title="從 GitHub 載入遠端資料">從 GitHub 載入</button>
        <button id="btnSaveGH" class="primary" title="存到 GitHub（提交 JSON 檔）">存到 GitHub</button>
        <button id="btnSettings">⚙ 設定</button>
      </div>
      <div class="muted" id="stat"></div>
    </div>
  </header>

  <main class="wrap" style="margin-top:12px">
    <section class="split">
      <div class="panel">
        <div class="flex" style="gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:8px">
          <input id="newType" placeholder="輸入新類型名稱（例：文件、教學、工具）" style="flex:1 1 240px"/>
          <button id="btnAddType">新增類型</button>
        </div>
        <div class="chips" id="typeChips"></div>
        <div class="muted" style="margin-top:6px">點各類型右側的「×」可刪除類型。</div>
      </div>

      <div class="panel">
        <div class="grid">
          <select id="typeSel"></select>
          <input id="desc" placeholder="描述 / 說明" />
          <input id="url" placeholder="https://...（超連結）" />
          <button id="btnAdd" class="primary">加入</button>
        </div>
        <div class="muted" style="margin-top:6px">提示：貼上網址後，按 <span class="kbd">Enter</span> 也可快速加入。</div>
      </div>
    </section>

    <section class="panel" style="margin-top:12px">
      <table class="tbl">
        <thead>
          <tr>
            <th style="width:60px">#</th>
            <th style="width:160px">類型</th>
            <th>描述</th>
            <th style="width:28%">連結</th>
            <th style="width:260px">操作</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>

    <p class="muted">Made with ❤｜資料預設存在本機（localStorage）。如需跨裝置，請用上方「設定」綁定 GitHub JSON + PAT 以同步。</p>
  </main>

  <!-- 編輯 Modal -->
  <dialog id="editDlg">
    <div class="modal">
      <header><strong>編輯資料</strong></header>
      <div class="body">
        <div class="grid" style="grid-template-columns:1fr 1fr">
          <label>類型<select id="editType"></select></label>
          <label>變更備註（選填）<input id="editNote" placeholder="例如：修正描述、更新網址"/></label>
        </div>
        <div class="sep"></div>
        <label>描述<textarea id="editDesc" rows="3" placeholder="此連結的用途或備註"></textarea></label>
        <div style="height:8px"></div>
        <label>連結<input id="editUrl" placeholder="https://..."/></label>
      </div>
      <div class="flex" style="padding:12px 16px">
        <span class="muted">會自動寫入變更歷程</span>
        <span class="right"></span>
        <button onclick="closeEdit()">取消</button>
        <button class="primary" id="btnSaveEdit">儲存</button>
      </div>
    </div>
  </dialog>

  <!-- 歷程 Modal -->
  <dialog id="histDlg">
    <div class="modal">
      <header><strong>修改歷程</strong></header>
      <div class="body" id="histBody"></div>
      <div class="flex" style="padding:12px 16px">
        <span class="muted">僅此筆記錄本地或遠端 JSON 內保存</span>
        <span class="right"></span>
        <button onclick="document.getElementById('histDlg').close()">關閉</button>
      </div>
    </div>
  </dialog>

  <!-- 類型刪除 Modal -->
  <dialog id="typeDlg">
    <div class="modal">
      <header><strong>刪除類型</strong></header>
      <div class="body">
        <div id="typeDlgMsg" class="muted"></div>
        <div class="sep"></div>
        <div class="flex">
          <button id="btnTypeReassign" class="warn" title="僅刪除類型，該類型的項目改為『未分類』">只刪類型（改為未分類）</button>
          <button id="btnTypePurge" class="danger" title="刪除類型並刪掉該類型下的所有項目">刪除類型與其項目</button>
          <span class="right"></span>
          <button onclick="document.getElementById('typeDlg').close()">取消</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- 設定 Modal （GitHub 連線） -->
  <dialog id="cfgDlg">
    <div class="modal">
      <header><strong>GitHub 同步設定</strong></header>
      <div class="body">
        <div class="grid" style="grid-template-columns:1fr 1fr; gap:10px">
          <label>Owner（使用者或組織）<input id="ghOwner" placeholder="你的 GitHub 使用者名稱"/></label>
          <label>Repo 名稱<input id="ghRepo" placeholder="你的 repo 名稱"/></label>
          <label>Branch（分支）<input id="ghBranch" value="main"/></label>
          <label>JSON 路徑（於 repo）<input id="ghPath" value="data/links.json"/></label>
        </div>
        <div style="height:10px"></div>
        <label>個人存取權杖 PAT
          <input id="ghToken" placeholder="僅儲存在本機 localStorage" />
        </label>
        <div class="muted" style="margin-top:6px">
          建議建立僅針對該 repo 的 Fine-grained PAT，授予 <span class="kbd">Contents: Read and Write</span> 權限。
        </div>
      </div>
      <div class="flex" style="padding:12px 16px">
        <span id="cfgStat" class="muted"></span>
        <span class="right"></span>
        <button onclick="document.getElementById('cfgDlg').close()">關閉</button>
        <button id="btnSaveCfg">儲存設定</button>
        <button id="btnTestCfg" class="primary">測試連線 / 讀取</button>
      </div>
    </div>
  </dialog>

  <script>
  // ====== 基本工具 ======
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const LS_KEY = 'links_db_v1';
  const LS_TYPES = 'links_types_v1';
  const LS_CFG = 'links_cfg_v1';

  /** @typedef {{ id:string, type:string, desc:string, url:string, createdAt:number, updatedAt:number, history:Array<{ts:number,action:string,note?:string,changes?:Record<string,{from:any,to:any}>}> }} Item */
  let state = /** @type {{ items: Item[], types: string[], ghSha?: string }} */ ({ items: [], types: [] });
  const cfg = loadCfg();

  function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8) }
  function now(){ return Date.now() }
  function setStat(s){ $('#stat').textContent = s }

  // ====== LocalStorage 讀寫 ======
  function saveLocal(){
    localStorage.setItem(LS_KEY, JSON.stringify({ items: state.items }));
    localStorage.setItem(LS_TYPES, JSON.stringify({ types: state.types }));
  }
  function loadLocal(){
    const a = localStorage.getItem(LS_KEY);
    const b = localStorage.getItem(LS_TYPES);
    if(a){ try{ state.items = JSON.parse(a).items || [] }catch{ state.items = [] } }
    if(b){ try{ state.types = JSON.parse(b).types || [] }catch{ state.types = [] } }
    if(state.types.length===0){ state.types = ['文件','教學','工具','研究','筆記'] }
  }

  // ====== 類型工具 ======
  function ensureType(t){ if(!state.types.includes(t)){ state.types.push(t); saveLocal(); } }
  function requestDeleteType(t){
    const n = state.items.filter(it=>it.type===t).length;
    $('#typeDlgMsg').textContent = `你正要刪除「${t}」。此類型共有 ${n} 筆項目。`;
    $('#typeDlg').dataset.targetType = t;
    $('#typeDlg').showModal();
  }
  function doDeleteType(t, mode){
    if(!t) return;
    if(mode==='reassign'){
      ensureType('未分類');
      state.items.forEach(it=>{ if(it.type===t){ it.history = it.history||[]; it.history.push({ts:now(),action:'edit',note:'刪除類型→未分類',changes:{type:{from:t,to:'未分類'}}}); it.type='未分類'; it.updatedAt=now(); }});
      state.types = state.types.filter(x=>x!==t);
    }else if(mode==='purge'){
      if(!confirm(`確定刪除類型「${t}」以及所有該類型項目？`)) return;
      state.items = state.items.filter(it=>it.type!==t);
      state.types = state.types.filter(x=>x!==t);
    }
    saveLocal(); renderTypes(); renderTable(); $('#typeDlg').close();
  }

  // ====== UI 繪製 ======
  function renderTypes(){
    // 供新增用的下拉
    const sel = $('#typeSel'); sel.innerHTML = '';
    state.types.sort((a,b)=>a.localeCompare(b,'zh-Hant'));
    for(const t of state.types){ const o=document.createElement('option'); o.value=o.textContent=t; sel.appendChild(o) }

    // 篩選下拉
    const f = $('#filterType'); f.innerHTML = '';
    for(const t of ['全部',...state.types]){ const o=document.createElement('option'); o.value=t; o.textContent=t; f.appendChild(o) }

    // Chips with delete ×
    const wrap = $('#typeChips'); wrap.innerHTML='';
    state.types.forEach(t=>{
      const chip=document.createElement('span'); chip.className='chip';
      const name=document.createElement('span'); name.textContent=t;
      const x=document.createElement('button'); x.className='x'; x.textContent='×'; x.title='刪除此類型';
      x.onclick=()=> requestDeleteType(t);
      chip.append(name,x); wrap.appendChild(chip);
    })
  }

  function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])) }
  function fmt(ts){ try{ return new Date(ts).toLocaleString() }catch{ return '' } }
  function hslToHex(h, s, l){ s/=100; l/=100; const k=n=> (n + h/30) % 12; const a=s*Math.min(l,1-l); const f=n=> l - a*Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n),1))); const toHex=x=> ('0'+Math.round(x*255).toString(16)).slice(-2); return '#'+toHex(f(0))+toHex(f(8))+toHex(f(4)); }
  function typeColor(name){ let h=0; for(let i=0;i<name.length;i++){ h = (h*31 + name.charCodeAt(i))>>>0 } h = h % 360; return hslToHex(h,60,52); }

  function renderTable(){
    const q = $('#q').value.trim().toLowerCase();
    const ft = $('#filterType').value;
    const sorter = $('#sorter').value;
    const tbody = $('#tbody'); tbody.innerHTML='';

    let rows = state.items.slice();
    if(q){ rows = rows.filter(it => [it.type,it.desc,it.url].join('\n').toLowerCase().includes(q)) }
    if(ft && ft !== '全部'){ rows = rows.filter(it => it.type===ft) }

    const sorters = {
      'updatedAt_desc': (a,b)=> b.updatedAt - a.updatedAt,
      'updatedAt_asc':  (a,b)=> a.updatedAt - b.updatedAt,
      'createdAt_desc': (a,b)=> b.createdAt - a.createdAt,
      'createdAt_asc':  (a,b)=> a.createdAt - b.createdAt,
      'type_asc':       (a,b)=> a.type.localeCompare(b.type,'zh-Hant')
    }
    rows.sort(sorters[sorter]||sorters.updatedAt_desc);

    rows.forEach((it,idx)=>{
      const tr=document.createElement('tr'); tr.className='row';
      const indexCell = `<td class="muted">${idx+1}</td>`;
      const typeCell = `<td><span class="chip" style="background:${typeColor(it.type)}20;border-color:${typeColor(it.type)}66">${escapeHtml(it.type)}</span><div class="muted">建立：${fmt(it.createdAt)} · 更新：${fmt(it.updatedAt)}</div></td>`;
      const descCell = `<td>${escapeHtml(it.desc||'')}</td>`;
      const linkCell = `<td><a class="link" href="${escapeHtml(it.url)}" target="_blank" rel="noopener">${escapeHtml(it.url)}</a></td>`;
      const toolsCell = document.createElement('td'); toolsCell.className='tools';
      const btnEdit = mkBtn('編輯',()=> openEdit(it.id));
      const btnDel  = mkBtn('刪除',()=> delItem(it.id),'danger');
      const btnCopy = mkBtn('複製連結',()=> copyText(it.url));
      const btnHist = mkBtn('歷程',()=> openHist(it.id));
      toolsCell.append(btnEdit, btnDel, btnCopy, btnHist);
      tr.innerHTML = indexCell + typeCell + descCell + linkCell;
      tr.appendChild(toolsCell);
      tbody.appendChild(tr);
    })

    setStat(`顯示 ${rows.length} / 全部 ${state.items.length} 筆`);
  }

  function mkBtn(text, onClick, cls=''){
    const b=document.createElement('button'); b.textContent=text; if(cls) b.classList.add(cls); b.onclick=onClick; return b
  }

  // ====== CRUD ======
  function addType(){
    const v = $('#newType').value.trim(); if(!v) return;
    if(!state.types.includes(v)){ state.types.push(v); saveLocal(); renderTypes() }
    $('#newType').value='';
  }
  function addItem(){
    const type=$('#typeSel').value.trim();
    const desc=$('#desc').value.trim();
    const url=$('#url').value.trim();
    if(!type||!url){ alert('類型與連結為必填'); return }
    const item={ id:uid(), type, desc, url, createdAt:now(), updatedAt:now(), history:[{ts:now(),action:'create',changes:{type:{to:type},desc:{to:desc},url:{to:url}}}] };
    state.items.unshift(item); saveLocal(); renderTable();
    $('#desc').value=''; $('#url').value=''; $('#url').focus();
  }
  function delItem(id){ if(!confirm('確定刪除此筆資料？')) return; state.items = state.items.filter(x=>x.id!==id); saveLocal(); renderTable(); }

  let editingId=null;
  function openEdit(id){ editingId=id; const it=state.items.find(x=>x.id===id); if(!it) return; const sel=$('#editType'); sel.innerHTML=''; state.types.forEach(t=>{ const o=document.createElement('option'); o.value=o.textContent=t; sel.appendChild(o) }); sel.value=it.type; $('#editDesc').value=it.desc; $('#editUrl').value=it.url; $('#editNote').value=''; $('#editDlg').showModal(); }
  function closeEdit(){ $('#editDlg').close(); editingId=null }
  function saveEdit(){ const it=state.items.find(x=>x.id===editingId); if(!it) return; const nType=$('#editType').value.trim(); const nDesc=$('#editDesc').value.trim(); const nUrl=$('#editUrl').value.trim(); const note=$('#editNote').value.trim(); const changes={}; if(it.type!==nType) changes.type={from:it.type,to:nType}; if(it.desc!==nDesc) changes.desc={from:it.desc,to:nDesc}; if(it.url!==nUrl) changes.url={from:it.url,to:nUrl}; it.type=nType; it.desc=nDesc; it.url=nUrl; it.updatedAt=now(); it.history.push({ts:now(),action:'edit',note,changes:Object.keys(changes).length?changes:undefined}); saveLocal(); renderTable(); closeEdit(); }

  function openHist(id){ const it=state.items.find(x=>x.id===id); if(!it) return; const box=$('#histBody'); box.innerHTML=''; if(!it.history?.length){ box.innerHTML='<div class="muted">尚無歷程</div>' } else { it.history.slice().reverse().forEach(h=>{ const d=document.createElement('div'); d.className='chip'; d.style.marginBottom='8px'; const title = `<div><strong>${h.action.toUpperCase()}</strong> · <span class="muted">${fmt(h.ts)}</span>${h.note?` · <span class="warn">${escapeHtml(h.note)}</span>`:''}</div>`; let diff=''; if(h.changes){ diff='<ul style="margin:6px 0 0 18px">' + Object.entries(h.changes).map(([k,v])=>`<li><span class="muted">${k}</span>：${escapeHtml(String(v.from||''))} → <span>${escapeHtml(String(v.to||''))}</span></li>`).join('') + '</ul>' } d.innerHTML=title+diff; box.appendChild(d); }) } $('#histDlg').showModal(); }

  async function copyText(t){ try{ await navigator.clipboard.writeText(t); setStat('已複製到剪貼簿') }catch{ alert('瀏覽器不支援自動複製，請手動選取') } }

  // ====== 匯出 / 匯入 ======
  function exportJSON(){ const payload = { version:1, exportedAt:now(), types:state.types, items:state.items }; const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`links_db_${new Date().toISOString().replace(/[:T]/g,'-').slice(0,19)}.json`; a.click(); URL.revokeObjectURL(a.href); setStat('已匯出 JSON 檔'); }
  function importJSON(file){ const reader=new FileReader(); reader.onload=e=>{ try{ const data=JSON.parse(String(e.target.result||'{}')); if(!data || !Array.isArray(data.items)) throw new Error('格式不正確'); state.items = data.items; state.types = Array.isArray(data.types) ? data.types : state.types; saveLocal(); renderTypes(); renderTable(); setStat('已匯入 JSON 並覆蓋現有資料'); }catch(err){ alert('匯入失敗：'+err.message) } }; reader.readAsText(file, 'utf-8'); }

  // ====== GitHub 同步（UTF-8 強制） ======
  function loadCfg(){ try{ return JSON.parse(localStorage.getItem(LS_CFG)||'{}') }catch{ return {} } }
  function saveCfg(v){ localStorage.setItem(LS_CFG, JSON.stringify(v||{})) }
  function openCfg(){ $('#ghOwner').value = cfg.owner||''; $('#ghRepo').value  = cfg.repo||''; $('#ghBranch').value= cfg.branch||'main'; $('#ghPath').value  = cfg.path||'data/links.json'; $('#ghToken').value = cfg.token||''; $('#cfgStat').textContent=''; $('#cfgDlg').showModal(); }
  function ghHeaders(){ const h={ 'Accept':'application/vnd.github+json' }; if(cfg.token) h['Authorization'] = `Bearer ${cfg.token}`; return h }

  // Base64 ⇄ UTF-8
  const textEncoder = new TextEncoder();
  const textDecoder = new TextDecoder('utf-8');
  function b64fromBytes(bytes){ let s=''; bytes.forEach(b=> s += String.fromCharCode(b)); return btoa(s) }
  function bytesFromB64(b64){ const bin=atob(b64||''); const len=bin.length; const arr=new Uint8Array(len); for(let i=0;i<len;i++) arr[i]=bin.charCodeAt(i); return arr }
  function b64EncodeUTF8(str){ return b64fromBytes(textEncoder.encode(str)) }
  function b64DecodeUTF8(b64){ return textDecoder.decode(bytesFromB64(b64)) }

  async function ghLoad(){
    if(!cfg.owner||!cfg.repo||!cfg.path){ alert('請先到設定填寫 owner/repo/path'); return }
    setStat('從 GitHub 讀取中…');
    const url=`https://api.github.com/repos/${encodeURIComponent(cfg.owner)}/${encodeURIComponent(cfg.repo)}/contents/${encodeURIComponent(cfg.path)}?ref=${encodeURIComponent(cfg.branch||'main')}`;
    const res=await fetch(url,{headers:ghHeaders()});
    if(res.status===404){ if(confirm('遠端檔案不存在，要建立一個新的嗎？（之後請按「存到 GitHub」）')){ state.items=[]; saveLocal(); renderTable(); return } else { setStat('已取消'); return } }
    if(!res.ok){ const t=await res.text(); alert('讀取失敗：'+res.status+'\n'+t); return }
    const json=await res.json();
    state.ghSha = json.sha;
    const content = b64DecodeUTF8(json.content||'');
    const data = JSON.parse(content||'{}');
    if(!data || !Array.isArray(data.items)) throw new Error('遠端 JSON 格式不正確');
    state.items = data.items; state.types = Array.isArray(data.types)?data.types:state.types;
    saveLocal(); renderTypes(); renderTable();
    setStat(`已從 GitHub 載入（${cfg.owner}/${cfg.repo}:${cfg.branch||'main'} · ${cfg.path}）`);
  }

  async function ghSave(){
    if(!cfg.owner||!cfg.repo||!cfg.path||!cfg.token){ alert('請先到設定填寫 owner/repo/path 與 PAT'); return }
    setStat('上傳至 GitHub…');
    if(!state.ghSha){ try{ await ghLoad() }catch{ /* 忽略 */ } }
    const payload = { version:1, updatedAt:now(), types:state.types, items:state.items };
    const content = b64EncodeUTF8(JSON.stringify(payload,null,2));
    const url=`https://api.github.com/repos/${encodeURIComponent(cfg.owner)}/${encodeURIComponent(cfg.repo)}/contents/${encodeURIComponent(cfg.path)}`;
    const body={ message:`chore: update links.json @ ${new Date().toISOString()}`, content, branch: cfg.branch||'main', sha: state.ghSha };
    const res=await fetch(url,{ method:'PUT', headers:{...ghHeaders(),'Content-Type':'application/json'}, body:JSON.stringify(body) });
    if(!res.ok){ const t=await res.text(); alert('儲存失敗：'+res.status+'\n'+t); return }
    const out=await res.json(); state.ghSha = out.content?.sha || undefined;
    setStat('已提交至 GitHub ✅');
  }

  // ====== 事件綁定 ======
  function bind(){
    $('#btnAddType').onclick=addType;
    $('#btnAdd').onclick=addItem;
    $('#url').addEventListener('keydown', e=>{ if(e.key==='Enter') addItem() });

    $('#q').oninput=renderTable; $('#filterType').onchange=renderTable; $('#sorter').onchange=renderTable;

    $('#btnExport').onclick=exportJSON;
    $('#btnImport').onclick=()=> $('#fileImport').click();
    $('#fileImport').onchange=(e)=>{ const f=e.target.files?.[0]; if(f) importJSON(f) };

    $('#btnLoadGH').onclick=ghLoad; $('#btnSaveGH').onclick=ghSave;
    $('#btnSettings').onclick=openCfg; $('#btnSaveCfg').onclick=()=>{ cfg.owner=$('#ghOwner').value.trim(); cfg.repo=$('#ghRepo').value.trim(); cfg.branch=$('#ghBranch').value.trim()||'main'; cfg.path=$('#ghPath').value.trim()||'data/links.json'; cfg.token=$('#ghToken').value.trim(); saveCfg(cfg); $('#cfgStat').textContent='已儲存設定（僅存於本機）'; };
    $('#btnTestCfg').onclick=async()=>{ try{ await ghLoad(); $('#cfgStat').textContent='讀取成功'; }catch(err){ $('#cfgStat').textContent='讀取失敗：'+err.message } };

    // 類型刪除 modal 綁定
    document.getElementById('btnTypeReassign').onclick=()=> doDeleteType($('#typeDlg').dataset.targetType,'reassign');
    document.getElementById('btnTypePurge').onclick=()=> doDeleteType($('#typeDlg').dataset.targetType,'purge');

    $('#btnSaveEdit').onclick=saveEdit;
  }

  // ====== 啟動 ======
  loadLocal(); renderTypes(); renderTable(); bind();
  </script>
</body>
</html>
