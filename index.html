<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å¯æ”œå¼é€£çµè¨˜äº‹ç°¿ Â· GitHub Pages ç‰ˆ</title>
  <style>
    :root{
      --bg: #0b1220; --panel:#121a2b; --muted:#9aa1ac; --txt:#e5e7eb; --border:#1f2937; --card:#0f172a;
      --primary:#60a5fa; --danger:#f87171; --warn:#fbbf24; --chip:#0c1526;
    }
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC, Helvetica, Arial; color:var(--txt); background:#0b1220}
    header{position:sticky;top:0;background:rgba(11,18,32,.75);backdrop-filter:saturate(160%) blur(8px);border-bottom:1px solid var(--border);z-index:20}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{font-size:18px;margin:0 0 8px}
    .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .bar > *{min-height:36px}
    input, select, textarea{background:#0d1628;color:var(--txt);border:1px solid var(--border);border-radius:8px;padding:8px}
    button{background:#111a2e;color:var(--txt);border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer}
    button.primary{background:linear-gradient(180deg,#2563eb,#1d4ed8);border-color:#1d4ed8}
    button.warn{background:#3b2a0a;border-color:#5a3f11;color:#fcd34d}
    button.danger{background:#2a1111;border-color:#512020;color:#fecaca}

    .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
    .muted{color:var(--muted)}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.split{grid-template-columns:1fr}}

    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:var(--chip);font-size:12px}
    .chip .x{padding:0 6px;border-radius:8px;background:#1f2a44;border:1px solid #2a395a;cursor:pointer}

    .grid{display:grid;grid-template-columns:1.2fr .8fr .8fr auto;gap:8px;align-items:center}

    .tbl{width:100%;border-spacing:0;border-collapse:separate}
    .tbl th,.tbl td{padding:10px 8px;border-bottom:1px solid var(--border);vertical-align:top}
    .tbl th{position:sticky;top:86px;background:rgba(15,23,42,.9);backdrop-filter:blur(6px);text-align:left;z-index:5}
    .row{background:var(--card)}
    .tools{display:flex;gap:6px;flex-wrap:wrap}
    .link{color:#a5b4fc;text-decoration:none}

    dialog{border:none;border-radius:16px;padding:0;background:#0b1220;color:var(--txt);box-shadow:0 30px 80px rgba(0,0,0,.5);max-width:640px}
    dialog::backdrop{background:rgba(0,0,0,.5)}
    .modal{padding:16px;border:1px solid var(--border)}
    .modal header{position:sticky;top:0;background:#0b1220;border-bottom:1px solid var(--border);padding:12px 16px}
    .modal .body{padding:16px}
    .flex{display:flex;gap:8px;align-items:center}
    .right{margin-left:auto}
    .sep{height:1px;background:var(--border);margin:8px 0}
    .kbd{font:12px/1.2 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#0c1424;padding:2px 6px;border-radius:6px;border:1px solid #182033}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>ğŸ”– å¯æ”œå¼é€£çµè¨˜äº‹ç°¿ <span class="muted">Â· å–®æª”ï¼ˆGitHub åŒæ­¥ / UTFâ€‘8 OKï¼‰</span></h1>
      <div class="bar">
        <input id="q" placeholder="æœå°‹ï¼šæè¿° / é€£çµ / é¡å‹ é—œéµå­—" class="grow" style="flex:1 1 280px" />
        <select id="filterType"></select>
        <select id="sorter">
          <option value="updatedAt_desc">æ›´æ–°æ™‚é–“ â¬‡ï¸</option>
          <option value="updatedAt_asc">æ›´æ–°æ™‚é–“ â¬†ï¸</option>
          <option value="createdAt_desc">å»ºç«‹æ™‚é–“ â¬‡ï¸</option>
          <option value="createdAt_asc">å»ºç«‹æ™‚é–“ â¬†ï¸</option>
          <option value="type_asc">é¡å‹ Aâ†’Z</option>
        </select>
        <button id="btnExport">åŒ¯å‡º JSON</button>
        <input id="fileImport" type="file" accept="application/json" style="display:none" />
        <button id="btnImport" class="warn">åŒ¯å…¥ JSON</button>
        <button id="btnLoadGH" title="å¾ GitHub è¼‰å…¥é ç«¯è³‡æ–™">å¾ GitHub è¼‰å…¥</button>
        <button id="btnSaveGH" class="primary" title="å­˜åˆ° GitHubï¼ˆæäº¤ JSON æª”ï¼‰">å­˜åˆ° GitHub</button>
        <button id="btnSettings">âš™ è¨­å®š</button>
      </div>
      <div class="muted" id="stat"></div>
    </div>
  </header>

  <main class="wrap" style="margin-top:12px">
    <section class="split">
      <div class="panel">
        <div class="flex" style="gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:8px">
          <input id="newType" placeholder="è¼¸å…¥æ–°é¡å‹åç¨±ï¼ˆä¾‹ï¼šæ–‡ä»¶ã€æ•™å­¸ã€å·¥å…·ï¼‰" style="flex:1 1 240px"/>
          <button id="btnAddType">æ–°å¢é¡å‹</button>
        </div>
        <div class="chips" id="typeChips"></div>
        <div class="muted" style="margin-top:6px">é»å„é¡å‹å³å´çš„ã€ŒÃ—ã€å¯åˆªé™¤é¡å‹ã€‚</div>
      </div>

      <div class="panel">
        <div class="grid">
          <select id="typeSel"></select>
          <input id="desc" placeholder="æè¿° / èªªæ˜" />
          <input id="url" placeholder="https://...ï¼ˆè¶…é€£çµï¼‰" />
          <button id="btnAdd" class="primary">åŠ å…¥</button>
        </div>
        <div class="muted" style="margin-top:6px">æç¤ºï¼šè²¼ä¸Šç¶²å€å¾Œï¼ŒæŒ‰ <span class="kbd">Enter</span> ä¹Ÿå¯å¿«é€ŸåŠ å…¥ã€‚</div>
      </div>
    </section>

    <section class="panel" style="margin-top:12px">
      <table class="tbl">
        <thead>
          <tr>
            <th style="width:60px">#</th>
            <th style="width:160px">é¡å‹</th>
            <th>æè¿°</th>
            <th style="width:28%">é€£çµ</th>
            <th style="width:260px">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>

    <p class="muted">Made with â¤ï½œè³‡æ–™é è¨­å­˜åœ¨æœ¬æ©Ÿï¼ˆlocalStorageï¼‰ã€‚å¦‚éœ€è·¨è£ç½®ï¼Œè«‹ç”¨ä¸Šæ–¹ã€Œè¨­å®šã€ç¶å®š GitHub JSON + PAT ä»¥åŒæ­¥ã€‚</p>
  </main>

  <!-- ç·¨è¼¯ Modal -->
  <dialog id="editDlg">
    <div class="modal">
      <header><strong>ç·¨è¼¯è³‡æ–™</strong></header>
      <div class="body">
        <div class="grid" style="grid-template-columns:1fr 1fr">
          <label>é¡å‹<select id="editType"></select></label>
          <label>è®Šæ›´å‚™è¨»ï¼ˆé¸å¡«ï¼‰<input id="editNote" placeholder="ä¾‹å¦‚ï¼šä¿®æ­£æè¿°ã€æ›´æ–°ç¶²å€"/></label>
        </div>
        <div class="sep"></div>
        <label>æè¿°<textarea id="editDesc" rows="3" placeholder="æ­¤é€£çµçš„ç”¨é€”æˆ–å‚™è¨»"></textarea></label>
        <div style="height:8px"></div>
        <label>é€£çµ<input id="editUrl" placeholder="https://..."/></label>
      </div>
      <div class="flex" style="padding:12px 16px">
        <span class="muted">æœƒè‡ªå‹•å¯«å…¥è®Šæ›´æ­·ç¨‹</span>
        <span class="right"></span>
        <button onclick="closeEdit()">å–æ¶ˆ</button>
        <button class="primary" id="btnSaveEdit">å„²å­˜</button>
      </div>
    </div>
  </dialog>

  <!-- æ­·ç¨‹ Modal -->
  <dialog id="histDlg">
    <div class="modal">
      <header><strong>ä¿®æ”¹æ­·ç¨‹</strong></header>
      <div class="body" id="histBody"></div>
      <div class="flex" style="padding:12px 16px">
        <span class="muted">åƒ…æ­¤ç­†è¨˜éŒ„æœ¬åœ°æˆ–é ç«¯ JSON å…§ä¿å­˜</span>
        <span class="right"></span>
        <button onclick="document.getElementById('histDlg').close()">é—œé–‰</button>
      </div>
    </div>
  </dialog>

  <!-- é¡å‹åˆªé™¤ Modal -->
  <dialog id="typeDlg">
    <div class="modal">
      <header><strong>åˆªé™¤é¡å‹</strong></header>
      <div class="body">
        <div id="typeDlgMsg" class="muted"></div>
        <div class="sep"></div>
        <div class="flex">
          <button id="btnTypeReassign" class="warn" title="åƒ…åˆªé™¤é¡å‹ï¼Œè©²é¡å‹çš„é …ç›®æ”¹ç‚ºã€æœªåˆ†é¡ã€">åªåˆªé¡å‹ï¼ˆæ”¹ç‚ºæœªåˆ†é¡ï¼‰</button>
          <button id="btnTypePurge" class="danger" title="åˆªé™¤é¡å‹ä¸¦åˆªæ‰è©²é¡å‹ä¸‹çš„æ‰€æœ‰é …ç›®">åˆªé™¤é¡å‹èˆ‡å…¶é …ç›®</button>
          <span class="right"></span>
          <button onclick="document.getElementById('typeDlg').close()">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- è¨­å®š Modal ï¼ˆGitHub é€£ç·šï¼‰ -->
  <dialog id="cfgDlg">
    <div class="modal">
      <header><strong>GitHub åŒæ­¥è¨­å®š</strong></header>
      <div class="body">
        <div class="grid" style="grid-template-columns:1fr 1fr; gap:10px">
          <label>Ownerï¼ˆä½¿ç”¨è€…æˆ–çµ„ç¹”ï¼‰<input id="ghOwner" placeholder="ä½ çš„ GitHub ä½¿ç”¨è€…åç¨±"/></label>
          <label>Repo åç¨±<input id="ghRepo" placeholder="ä½ çš„ repo åç¨±"/></label>
          <label>Branchï¼ˆåˆ†æ”¯ï¼‰<input id="ghBranch" value="main"/></label>
          <label>JSON è·¯å¾‘ï¼ˆæ–¼ repoï¼‰<input id="ghPath" value="data/links.json"/></label>
        </div>
        <div style="height:10px"></div>
        <label>å€‹äººå­˜å–æ¬Šæ– PAT
          <input id="ghToken" placeholder="åƒ…å„²å­˜åœ¨æœ¬æ©Ÿ localStorage" />
        </label>
        <div class="muted" style="margin-top:6px">
          å»ºè­°å»ºç«‹åƒ…é‡å°è©² repo çš„ Fine-grained PATï¼Œæˆäºˆ <span class="kbd">Contents: Read and Write</span> æ¬Šé™ã€‚
        </div>
      </div>
      <div class="flex" style="padding:12px 16px">
        <span id="cfgStat" class="muted"></span>
        <span class="right"></span>
        <button onclick="document.getElementById('cfgDlg').close()">é—œé–‰</button>
        <button id="btnSaveCfg">å„²å­˜è¨­å®š</button>
        <button id="btnTestCfg" class="primary">æ¸¬è©¦é€£ç·š / è®€å–</button>
      </div>
    </div>
  </dialog>

  <script>
  // ====== åŸºæœ¬å·¥å…· ======
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const LS_KEY = 'links_db_v1';
  const LS_TYPES = 'links_types_v1';
  const LS_CFG = 'links_cfg_v1';

  /** @typedef {{ id:string, type:string, desc:string, url:string, createdAt:number, updatedAt:number, history:Array<{ts:number,action:string,note?:string,changes?:Record<string,{from:any,to:any}>}> }} Item */
  let state = /** @type {{ items: Item[], types: string[], ghSha?: string }} */ ({ items: [], types: [] });
  const cfg = loadCfg();

  function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8) }
  function now(){ return Date.now() }
  function setStat(s){ $('#stat').textContent = s }

  // ====== LocalStorage è®€å¯« ======
  function saveLocal(){
    localStorage.setItem(LS_KEY, JSON.stringify({ items: state.items }));
    localStorage.setItem(LS_TYPES, JSON.stringify({ types: state.types }));
  }
  function loadLocal(){
    const a = localStorage.getItem(LS_KEY);
    const b = localStorage.getItem(LS_TYPES);
    if(a){ try{ state.items = JSON.parse(a).items || [] }catch{ state.items = [] } }
    if(b){ try{ state.types = JSON.parse(b).types || [] }catch{ state.types = [] } }
    if(state.types.length===0){ state.types = ['æ–‡ä»¶','æ•™å­¸','å·¥å…·','ç ”ç©¶','ç­†è¨˜'] }
  }

  // ====== é¡å‹å·¥å…· ======
  function ensureType(t){ if(!state.types.includes(t)){ state.types.push(t); saveLocal(); } }
  function requestDeleteType(t){
    const n = state.items.filter(it=>it.type===t).length;
    $('#typeDlgMsg').textContent = `ä½ æ­£è¦åˆªé™¤ã€Œ${t}ã€ã€‚æ­¤é¡å‹å…±æœ‰ ${n} ç­†é …ç›®ã€‚`;
    $('#typeDlg').dataset.targetType = t;
    $('#typeDlg').showModal();
  }
  function doDeleteType(t, mode){
    if(!t) return;
    if(mode==='reassign'){
      ensureType('æœªåˆ†é¡');
      state.items.forEach(it=>{ if(it.type===t){ it.history = it.history||[]; it.history.push({ts:now(),action:'edit',note:'åˆªé™¤é¡å‹â†’æœªåˆ†é¡',changes:{type:{from:t,to:'æœªåˆ†é¡'}}}); it.type='æœªåˆ†é¡'; it.updatedAt=now(); }});
      state.types = state.types.filter(x=>x!==t);
    }else if(mode==='purge'){
      if(!confirm(`ç¢ºå®šåˆªé™¤é¡å‹ã€Œ${t}ã€ä»¥åŠæ‰€æœ‰è©²é¡å‹é …ç›®ï¼Ÿ`)) return;
      state.items = state.items.filter(it=>it.type!==t);
      state.types = state.types.filter(x=>x!==t);
    }
    saveLocal(); renderTypes(); renderTable(); $('#typeDlg').close();
  }

  // ====== UI ç¹ªè£½ ======
  function renderTypes(){
    // ä¾›æ–°å¢ç”¨çš„ä¸‹æ‹‰
    const sel = $('#typeSel'); sel.innerHTML = '';
    state.types.sort((a,b)=>a.localeCompare(b,'zh-Hant'));
    for(const t of state.types){ const o=document.createElement('option'); o.value=o.textContent=t; sel.appendChild(o) }

    // ç¯©é¸ä¸‹æ‹‰
    const f = $('#filterType'); f.innerHTML = '';
    for(const t of ['å…¨éƒ¨',...state.types]){ const o=document.createElement('option'); o.value=t; o.textContent=t; f.appendChild(o) }

    // Chips with delete Ã—
    const wrap = $('#typeChips'); wrap.innerHTML='';
    state.types.forEach(t=>{
      const chip=document.createElement('span'); chip.className='chip';
      const name=document.createElement('span'); name.textContent=t;
      const x=document.createElement('button'); x.className='x'; x.textContent='Ã—'; x.title='åˆªé™¤æ­¤é¡å‹';
      x.onclick=()=> requestDeleteType(t);
      chip.append(name,x); wrap.appendChild(chip);
    })
  }

  function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])) }
  function fmt(ts){ try{ return new Date(ts).toLocaleString() }catch{ return '' } }
  function hslToHex(h, s, l){ s/=100; l/=100; const k=n=> (n + h/30) % 12; const a=s*Math.min(l,1-l); const f=n=> l - a*Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n),1))); const toHex=x=> ('0'+Math.round(x*255).toString(16)).slice(-2); return '#'+toHex(f(0))+toHex(f(8))+toHex(f(4)); }
  function typeColor(name){ let h=0; for(let i=0;i<name.length;i++){ h = (h*31 + name.charCodeAt(i))>>>0 } h = h % 360; return hslToHex(h,60,52); }

  function renderTable(){
    const q = $('#q').value.trim().toLowerCase();
    const ft = $('#filterType').value;
    const sorter = $('#sorter').value;
    const tbody = $('#tbody'); tbody.innerHTML='';

    let rows = state.items.slice();
    if(q){ rows = rows.filter(it => [it.type,it.desc,it.url].join('\n').toLowerCase().includes(q)) }
    if(ft && ft !== 'å…¨éƒ¨'){ rows = rows.filter(it => it.type===ft) }

    const sorters = {
      'updatedAt_desc': (a,b)=> b.updatedAt - a.updatedAt,
      'updatedAt_asc':  (a,b)=> a.updatedAt - b.updatedAt,
      'createdAt_desc': (a,b)=> b.createdAt - a.createdAt,
      'createdAt_asc':  (a,b)=> a.createdAt - b.createdAt,
      'type_asc':       (a,b)=> a.type.localeCompare(b.type,'zh-Hant')
    }
    rows.sort(sorters[sorter]||sorters.updatedAt_desc);

    rows.forEach((it,idx)=>{
      const tr=document.createElement('tr'); tr.className='row';
      const indexCell = `<td class="muted">${idx+1}</td>`;
      const typeCell = `<td><span class="chip" style="background:${typeColor(it.type)}20;border-color:${typeColor(it.type)}66">${escapeHtml(it.type)}</span><div class="muted">å»ºç«‹ï¼š${fmt(it.createdAt)} Â· æ›´æ–°ï¼š${fmt(it.updatedAt)}</div></td>`;
      const descCell = `<td>${escapeHtml(it.desc||'')}</td>`;
      const linkCell = `<td><a class="link" href="${escapeHtml(it.url)}" target="_blank" rel="noopener">${escapeHtml(it.url)}</a></td>`;
      const toolsCell = document.createElement('td'); toolsCell.className='tools';
      const btnEdit = mkBtn('ç·¨è¼¯',()=> openEdit(it.id));
      const btnDel  = mkBtn('åˆªé™¤',()=> delItem(it.id),'danger');
      const btnCopy = mkBtn('è¤‡è£½é€£çµ',()=> copyText(it.url));
      const btnHist = mkBtn('æ­·ç¨‹',()=> openHist(it.id));
      toolsCell.append(btnEdit, btnDel, btnCopy, btnHist);
      tr.innerHTML = indexCell + typeCell + descCell + linkCell;
      tr.appendChild(toolsCell);
      tbody.appendChild(tr);
    })

    setStat(`é¡¯ç¤º ${rows.length} / å…¨éƒ¨ ${state.items.length} ç­†`);
  }

  function mkBtn(text, onClick, cls=''){
    const b=document.createElement('button'); b.textContent=text; if(cls) b.classList.add(cls); b.onclick=onClick; return b
  }

  // ====== CRUD ======
  function addType(){
    const v = $('#newType').value.trim(); if(!v) return;
    if(!state.types.includes(v)){ state.types.push(v); saveLocal(); renderTypes() }
    $('#newType').value='';
  }
  function addItem(){
    const type=$('#typeSel').value.trim();
    const desc=$('#desc').value.trim();
    const url=$('#url').value.trim();
    if(!type||!url){ alert('é¡å‹èˆ‡é€£çµç‚ºå¿…å¡«'); return }
    const item={ id:uid(), type, desc, url, createdAt:now(), updatedAt:now(), history:[{ts:now(),action:'create',changes:{type:{to:type},desc:{to:desc},url:{to:url}}}] };
    state.items.unshift(item); saveLocal(); renderTable();
    $('#desc').value=''; $('#url').value=''; $('#url').focus();
  }
  function delItem(id){ if(!confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†è³‡æ–™ï¼Ÿ')) return; state.items = state.items.filter(x=>x.id!==id); saveLocal(); renderTable(); }

  let editingId=null;
  function openEdit(id){ editingId=id; const it=state.items.find(x=>x.id===id); if(!it) return; const sel=$('#editType'); sel.innerHTML=''; state.types.forEach(t=>{ const o=document.createElement('option'); o.value=o.textContent=t; sel.appendChild(o) }); sel.value=it.type; $('#editDesc').value=it.desc; $('#editUrl').value=it.url; $('#editNote').value=''; $('#editDlg').showModal(); }
  function closeEdit(){ $('#editDlg').close(); editingId=null }
  function saveEdit(){ const it=state.items.find(x=>x.id===editingId); if(!it) return; const nType=$('#editType').value.trim(); const nDesc=$('#editDesc').value.trim(); const nUrl=$('#editUrl').value.trim(); const note=$('#editNote').value.trim(); const changes={}; if(it.type!==nType) changes.type={from:it.type,to:nType}; if(it.desc!==nDesc) changes.desc={from:it.desc,to:nDesc}; if(it.url!==nUrl) changes.url={from:it.url,to:nUrl}; it.type=nType; it.desc=nDesc; it.url=nUrl; it.updatedAt=now(); it.history.push({ts:now(),action:'edit',note,changes:Object.keys(changes).length?changes:undefined}); saveLocal(); renderTable(); closeEdit(); }

  function openHist(id){ const it=state.items.find(x=>x.id===id); if(!it) return; const box=$('#histBody'); box.innerHTML=''; if(!it.history?.length){ box.innerHTML='<div class="muted">å°šç„¡æ­·ç¨‹</div>' } else { it.history.slice().reverse().forEach(h=>{ const d=document.createElement('div'); d.className='chip'; d.style.marginBottom='8px'; const title = `<div><strong>${h.action.toUpperCase()}</strong> Â· <span class="muted">${fmt(h.ts)}</span>${h.note?` Â· <span class="warn">${escapeHtml(h.note)}</span>`:''}</div>`; let diff=''; if(h.changes){ diff='<ul style="margin:6px 0 0 18px">' + Object.entries(h.changes).map(([k,v])=>`<li><span class="muted">${k}</span>ï¼š${escapeHtml(String(v.from||''))} â†’ <span>${escapeHtml(String(v.to||''))}</span></li>`).join('') + '</ul>' } d.innerHTML=title+diff; box.appendChild(d); }) } $('#histDlg').showModal(); }

  async function copyText(t){ try{ await navigator.clipboard.writeText(t); setStat('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿') }catch{ alert('ç€è¦½å™¨ä¸æ”¯æ´è‡ªå‹•è¤‡è£½ï¼Œè«‹æ‰‹å‹•é¸å–') } }

  // ====== åŒ¯å‡º / åŒ¯å…¥ ======
  function exportJSON(){ const payload = { version:1, exportedAt:now(), types:state.types, items:state.items }; const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`links_db_${new Date().toISOString().replace(/[:T]/g,'-').slice(0,19)}.json`; a.click(); URL.revokeObjectURL(a.href); setStat('å·²åŒ¯å‡º JSON æª”'); }
  function importJSON(file){ const reader=new FileReader(); reader.onload=e=>{ try{ const data=JSON.parse(String(e.target.result||'{}')); if(!data || !Array.isArray(data.items)) throw new Error('æ ¼å¼ä¸æ­£ç¢º'); state.items = data.items; state.types = Array.isArray(data.types) ? data.types : state.types; saveLocal(); renderTypes(); renderTable(); setStat('å·²åŒ¯å…¥ JSON ä¸¦è¦†è“‹ç¾æœ‰è³‡æ–™'); }catch(err){ alert('åŒ¯å…¥å¤±æ•—ï¼š'+err.message) } }; reader.readAsText(file, 'utf-8'); }

  // ====== GitHub åŒæ­¥ï¼ˆUTF-8 å¼·åˆ¶ï¼‰ ======
  function loadCfg(){ try{ return JSON.parse(localStorage.getItem(LS_CFG)||'{}') }catch{ return {} } }
  function saveCfg(v){ localStorage.setItem(LS_CFG, JSON.stringify(v||{})) }
  function openCfg(){ $('#ghOwner').value = cfg.owner||''; $('#ghRepo').value  = cfg.repo||''; $('#ghBranch').value= cfg.branch||'main'; $('#ghPath').value  = cfg.path||'data/links.json'; $('#ghToken').value = cfg.token||''; $('#cfgStat').textContent=''; $('#cfgDlg').showModal(); }
  function ghHeaders(){ const h={ 'Accept':'application/vnd.github+json' }; if(cfg.token) h['Authorization'] = `Bearer ${cfg.token}`; return h }

  // Base64 â‡„ UTF-8
  const textEncoder = new TextEncoder();
  const textDecoder = new TextDecoder('utf-8');
  function b64fromBytes(bytes){ let s=''; bytes.forEach(b=> s += String.fromCharCode(b)); return btoa(s) }
  function bytesFromB64(b64){ const bin=atob(b64||''); const len=bin.length; const arr=new Uint8Array(len); for(let i=0;i<len;i++) arr[i]=bin.charCodeAt(i); return arr }
  function b64EncodeUTF8(str){ return b64fromBytes(textEncoder.encode(str)) }
  function b64DecodeUTF8(b64){ return textDecoder.decode(bytesFromB64(b64)) }

  async function ghLoad(){
    if(!cfg.owner||!cfg.repo||!cfg.path){ alert('è«‹å…ˆåˆ°è¨­å®šå¡«å¯« owner/repo/path'); return }
    setStat('å¾ GitHub è®€å–ä¸­â€¦');
    const url=`https://api.github.com/repos/${encodeURIComponent(cfg.owner)}/${encodeURIComponent(cfg.repo)}/contents/${encodeURIComponent(cfg.path)}?ref=${encodeURIComponent(cfg.branch||'main')}`;
    const res=await fetch(url,{headers:ghHeaders()});
    if(res.status===404){ if(confirm('é ç«¯æª”æ¡ˆä¸å­˜åœ¨ï¼Œè¦å»ºç«‹ä¸€å€‹æ–°çš„å—ï¼Ÿï¼ˆä¹‹å¾Œè«‹æŒ‰ã€Œå­˜åˆ° GitHubã€ï¼‰')){ state.items=[]; saveLocal(); renderTable(); return } else { setStat('å·²å–æ¶ˆ'); return } }
    if(!res.ok){ const t=await res.text(); alert('è®€å–å¤±æ•—ï¼š'+res.status+'\n'+t); return }
    const json=await res.json();
    state.ghSha = json.sha;
    const content = b64DecodeUTF8(json.content||'');
    const data = JSON.parse(content||'{}');
    if(!data || !Array.isArray(data.items)) throw new Error('é ç«¯ JSON æ ¼å¼ä¸æ­£ç¢º');
    state.items = data.items; state.types = Array.isArray(data.types)?data.types:state.types;
    saveLocal(); renderTypes(); renderTable();
    setStat(`å·²å¾ GitHub è¼‰å…¥ï¼ˆ${cfg.owner}/${cfg.repo}:${cfg.branch||'main'} Â· ${cfg.path}ï¼‰`);
  }

  async function ghSave(){
    if(!cfg.owner||!cfg.repo||!cfg.path||!cfg.token){ alert('è«‹å…ˆåˆ°è¨­å®šå¡«å¯« owner/repo/path èˆ‡ PAT'); return }
    setStat('ä¸Šå‚³è‡³ GitHubâ€¦');
    if(!state.ghSha){ try{ await ghLoad() }catch{ /* å¿½ç•¥ */ } }
    const payload = { version:1, updatedAt:now(), types:state.types, items:state.items };
    const content = b64EncodeUTF8(JSON.stringify(payload,null,2));
    const url=`https://api.github.com/repos/${encodeURIComponent(cfg.owner)}/${encodeURIComponent(cfg.repo)}/contents/${encodeURIComponent(cfg.path)}`;
    const body={ message:`chore: update links.json @ ${new Date().toISOString()}`, content, branch: cfg.branch||'main', sha: state.ghSha };
    const res=await fetch(url,{ method:'PUT', headers:{...ghHeaders(),'Content-Type':'application/json'}, body:JSON.stringify(body) });
    if(!res.ok){ const t=await res.text(); alert('å„²å­˜å¤±æ•—ï¼š'+res.status+'\n'+t); return }
    const out=await res.json(); state.ghSha = out.content?.sha || undefined;
    setStat('å·²æäº¤è‡³ GitHub âœ…');
  }

  // ====== äº‹ä»¶ç¶å®š ======
  function bind(){
    $('#btnAddType').onclick=addType;
    $('#btnAdd').onclick=addItem;
    $('#url').addEventListener('keydown', e=>{ if(e.key==='Enter') addItem() });

    $('#q').oninput=renderTable; $('#filterType').onchange=renderTable; $('#sorter').onchange=renderTable;

    $('#btnExport').onclick=exportJSON;
    $('#btnImport').onclick=()=> $('#fileImport').click();
    $('#fileImport').onchange=(e)=>{ const f=e.target.files?.[0]; if(f) importJSON(f) };

    $('#btnLoadGH').onclick=ghLoad; $('#btnSaveGH').onclick=ghSave;
    $('#btnSettings').onclick=openCfg; $('#btnSaveCfg').onclick=()=>{ cfg.owner=$('#ghOwner').value.trim(); cfg.repo=$('#ghRepo').value.trim(); cfg.branch=$('#ghBranch').value.trim()||'main'; cfg.path=$('#ghPath').value.trim()||'data/links.json'; cfg.token=$('#ghToken').value.trim(); saveCfg(cfg); $('#cfgStat').textContent='å·²å„²å­˜è¨­å®šï¼ˆåƒ…å­˜æ–¼æœ¬æ©Ÿï¼‰'; };
    $('#btnTestCfg').onclick=async()=>{ try{ await ghLoad(); $('#cfgStat').textContent='è®€å–æˆåŠŸ'; }catch(err){ $('#cfgStat').textContent='è®€å–å¤±æ•—ï¼š'+err.message } };

    // é¡å‹åˆªé™¤ modal ç¶å®š
    document.getElementById('btnTypeReassign').onclick=()=> doDeleteType($('#typeDlg').dataset.targetType,'reassign');
    document.getElementById('btnTypePurge').onclick=()=> doDeleteType($('#typeDlg').dataset.targetType,'purge');

    $('#btnSaveEdit').onclick=saveEdit;
  }

  // ====== å•Ÿå‹• ======
  loadLocal(); renderTypes(); renderTable(); bind();
  </script>
</body>
</html>
