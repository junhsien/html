<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>可攜式連結記事簿 · GitHub Pages 版</title>
  <style>
    :root{
      --bg: #0b1220; --panel:#121a2b; --muted:#6b7280; --txt:#e5e7eb; --primary:#60a5fa; --accent:#34d399; --danger:#f87171; --warn:#fbbf24; --card:#0f172a; --border:#1f2937;
    }
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";color:var(--txt);background:linear-gradient(180deg,#0b1220 0,#0b1220 300px,#0a1020 100%)}
    header{position:sticky;top:0;background:rgba(11,18,32,.75);backdrop-filter:saturate(160%) blur(8px);border-bottom:1px solid var(--border);z-index:50}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{font-size:18px;margin:0 0 8px}
    .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .bar > *{min-height:36px}
    input, select, textarea{background:#0d1628;color:var(--txt);border:1px solid var(--border);border-radius:8px;padding:8px}
    input::placeholder, textarea::placeholder{color:#9aa1ac}
    button{background:#111a2e;color:var(--txt);border:1px solid var(--border);border-radius:10px;padding:6px 10px;cursor:pointer}
    button.primary{background:linear-gradient(180deg,#2563eb,#1d4ed8);border-color:#1d4ed8}
    button.ghost{background:transparent}
    button.warn{background:#3b2a0a;border-color:#5a3f11;color:#fcd34d}
    button.danger{background:#2a1111;border-color:#512020;color:#fecaca}
    button:disabled{opacity:.5;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:1.2fr .8fr .8fr auto;gap:8px;align-items:center}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
    .muted{color:var(--muted)}
    .inline{display:inline-flex;gap:8px;flex-wrap:wrap;align-items:center}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#0c1526;font-size:12px;display:inline-flex;align-items:center;gap:6px}
    .chip button{font-size:10px;padding:0 6px;border-radius:50%;line-height:1;color:#fecaca;border-color:#512020;background:#2a1111}
    .tbl{width:100%;border-spacing:0;border-collapse:separate}
    .tbl th,.tbl td{padding:10px 8px;border-bottom:1px solid var(--border);vertical-align:top}
    .tbl th{position:sticky;top:86px;background:rgba(15,23,42,.9);backdrop-filter:blur(6px);text-align:left;z-index:5}
    .row{background:var(--card)}
    .kbd{font:12px/1.2 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#0c1424;padding:2px 6px;border-radius:6px;border:1px solid #182033}
    .badge{display:inline-flex;align-items:center;gap:8px}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
    .pill{border-radius:999px;padding:4px 8px;background:#0e1a2d;border:1px solid #1c2a44}
    .link{color:#a5b4fc;text-decoration:none}
    .link:hover{text-decoration:underline}
    .tools{display:flex;gap:6px;flex-wrap:wrap}
    .tools button{padding:6px 10px;border-radius:8px}
    .footer{color:#9aa1ac;font-size:12px}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.split{grid-template-columns:1fr}}
    .hidden{display:none !important}
    dialog{border:none;border-radius:16px;padding:0;background:#0b1220;color:var(--txt);box-shadow:0 30px 80px rgba(0,0,0,.5);max-width:640px}
    dialog::backdrop{background:rgba(0,0,0,.5)}
    .modal{padding:16px;border:1px solid var(--border)}
    .modal header{position:sticky;top:0;background:#0b1220;border-bottom:1px solid var(--border);padding:12px 16px}
    .modal .body{padding:16px}
    .flex{display:flex;gap:8px;align-items:center}
    .grow{flex:1}
    .right{margin-left:auto}
    .warntext{color:#fbbf24}
    .oktext{color:#86efac}
    .stat{font-size:12px;color:var(--muted)}
    .sep{height:1px;background:var(--border);margin:8px 0}
    .highlight{background:rgba(96,165,250,.08);border:1px dashed #1d4ed8}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>🔖 可攜式連結記事簿 <span class="muted">· 單檔版（GitHub Pages OK）</span></h1>
      <div class="bar">
        <input id="q" placeholder="搜尋：描述 / 連結 / 類型 關鍵字" class="grow" />
        <select id="filterType"></select>
        <select id="sorter">
          <option value="updatedAt_desc">更新時間 ⬇︎</option>
          <option value="updatedAt_asc">更新時間 ⬆︎</option>
          <option value="createdAt_desc">建立時間 ⬇︎</option>
          <option value="createdAt_asc">建立時間 ⬆︎</option>
          <option value="type_asc">類型 A→Z</option>
        </select>
        <button id="btnExport">匯出 JSON</button>
        <input id="fileImport" type="file" accept="application/json" class="hidden" />
        <button id="btnImport" class="warn">匯入 JSON</button>
        <button id="btnLoadGH">從 GitHub 載入</button>
        <button id="btnSaveGH" class="primary">存到 GitHub</button>
        <button id="btnSettings" class="ghost">⚙ 設定</button>
      </div>
      <div class="stat" id="stat"></div>
    </div>
  </header>

  <main class="wrap" style="margin-top:12px">
    <section class="split">
      <div class="panel">
        <div class="inline" style="margin-bottom:8px">
          <div class="muted">快速新增/刪除類型</div>
          <input id="newType" placeholder="輸入新類型名稱（例：文件、教學、工具）" class="grow" />
          <button id="btnAddType">新增類型</button>
        </div>
        <div class="chips" id="typeChips"></div>
      </div>

      <div class="panel">
        <div class="grid">
          <select id="typeSel"></select>
          <input id="desc" placeholder="描述 / 說明" />
          <input id="url" placeholder="https://...（超連結）" />
          <button id="btnAdd" class="primary">加入</button>
        </div>
        <div class="muted" style="margin-top:6px">提示：貼上網址後，按 <span class="kbd">Enter</span> 也可快速加入。</div>
      </div>
    </section>

    <section class="panel" style="margin-top:12px">
      <table class="tbl" id="itemsTbl">
        <thead>
          <tr>
            <th style="width:60px">#</th>
            <th style="width:160px">類型</th>
            <th>描述</th>
            <th style="width:28%">連結</th>
            <th style="width:260px">操作</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>
  </main>

  <script>
  const $=s=>document.querySelector(s);
  const LS_KEY='links_db_v1', LS_TYPES='links_types_v1';
  let state={items:[],types:[]};

  function saveLocal(){
    localStorage.setItem(LS_KEY,JSON.stringify({items:state.items}));
    localStorage.setItem(LS_TYPES,JSON.stringify({types:state.types}));
  }
  function loadLocal(){
    try{state.items=JSON.parse(localStorage.getItem(LS_KEY)||'{}').items||[]}catch{}
    try{state.types=JSON.parse(localStorage.getItem(LS_TYPES)||'{}').types||[]}catch{}
    if(!state.types.length) state.types=['文件','教學','工具'];
  }

  function renderTypes(){
    const sel=$('#typeSel'); sel.innerHTML='';
    state.types.forEach(t=>{const o=document.createElement('option');o.value=o.textContent=t;sel.appendChild(o)});
    const f=$('#filterType'); f.innerHTML='';
    ['全部',...state.types].forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t;f.appendChild(o)});
    const wrap=$('#typeChips'); wrap.innerHTML='';
    state.types.forEach(t=>{
      const c=document.createElement('div'); c.className='chip'; c.textContent=t;
      const del=document.createElement('button'); del.textContent='×'; del.title='刪除此類型';
      del.onclick=()=>delType(t);
      c.appendChild(del);
      wrap.appendChild(c);
    });
  }

  function addType(){
    const v=$('#newType').value.trim(); if(!v) return;
    if(!state.types.includes(v)){state.types.push(v);saveLocal();renderTypes()}
    $('#newType').value='';
  }
  function delType(t){
    if(!confirm(`確定刪除類型「${t}」？\n注意：已有此類型的項目將保留，但無法再選取新增`)) return;
    state.types=state.types.filter(x=>x!==t);
    saveLocal(); renderTypes();
  }

  function addItem(){
    const type=$('#typeSel').value, desc=$('#desc').value.trim(), url=$('#url').value.trim();
    if(!type||!url) return alert('類型與連結必填');
    const item={id:Date.now().toString(36),type,desc,url};
    state.items.unshift(item); saveLocal(); renderTable(); $('#desc').value=''; $('#url').value='';
  }

  function renderTable(){
    const tbody=$('#tbody'); tbody.innerHTML='';
    state.items.forEach((it,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${i+1}</td><td>${it.type}</td><td>${it.desc||''}</td><td><a href="${it.url}" target="_blank">${it.url}</a></td>`;
      const td=document.createElement('td');
      const b=document.createElement('button'); b.textContent='刪除'; b.className='danger'; b.onclick=()=>{if(confirm('刪除?')){state.items=state.items.filter(x=>x.id!==it.id);saveLocal();renderTable();}};
      td.appendChild(b); tr.appendChild(td); tbody.appendChild(tr);
    });
  }

  document.getElementById('btnAddType').onclick=addType;
  document.getElementById('btnAdd').onclick=addItem;

  loadLocal(); renderTypes(); renderTable();
  </script>
  
  <!-- 類型刪除支援（附加腳本） -->
  <script>
  (function(){
    // 若主程式尚未定義 ensureType，補上
    if(typeof window.ensureType !== 'function'){
      window.ensureType = function(t){ try{ if(!window.state) window.state={}; if(!state.types.includes(t)) state.types.push(t) }catch(e){} }
    }
    // 類型刪除/重指定
    if(typeof window.requestDeleteType !== 'function'){
      window.requestDeleteType = function(t){
        const n = (window.state?.items || window.state?.items === undefined) ? (state.items||[]).filter(it=>it.type===t).length : (state.items||[]).filter(it=>it.type===t).length;
        const dlg = document.getElementById('typeDlg');
        if(!dlg){ alert('找不到刪除類型對話框'); return }
        document.getElementById('typeDlgMsg').textContent = `你正要刪除「${t}」。此類型共有 ${n} 筆項目。`;
        dlg.dataset.targetType = t; dlg.showModal();
      }
    }
    if(typeof window.doDeleteType !== 'function'){
      window.doDeleteType = function(t, mode){
        if(!t) return;
        if(mode==='reassign'){
          ensureType('未分類');
          (state.items||[]).forEach(it=>{ if(it.type===t){ it.history = it.history||[]; it.history.push({ts:Date.now(),action:'edit',note:'刪除類型，改為未分類',changes:{type:{from:t,to:'未分類'}}}); it.type='未分類'; it.updatedAt=Date.now(); }});
          state.types = (state.types||[]).filter(x=>x!==t);
        }else if(mode==='purge'){
          if(!confirm(`確定刪除類型「${t}」以及所有該類型項目？`)) return;
          state.items = (state.items||[]).filter(it=>it.type!==t);
          state.types = (state.types||[]).filter(x=>x!==t);
        }
        if(typeof saveLocal==='function') saveLocal();
        if(typeof renderTypes==='function') renderTypes();
        if(typeof renderTable==='function') renderTable();
        const dlg=document.getElementById('typeDlg'); if(dlg) dlg.close();
      }
    }
    // 綁定對話框按鈕（若存在）
    const typeDlg=document.getElementById('typeDlg');
    if(typeDlg){
      const reassign=document.getElementById('btnTypeReassign');
      const purge=document.getElementById('btnTypePurge');
      if(reassign) reassign.onclick=()=> window.doDeleteType(typeDlg.dataset.targetType,'reassign');
      if(purge) purge.onclick=()=> window.doDeleteType(typeDlg.dataset.targetType,'purge');
    }
  })();
  </script>
</body>
</html>
