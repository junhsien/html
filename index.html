<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>可攜式連結記事簿 · GitHub Pages 版</title>
  <style>
    :root{
      --bg: #0b1220; --panel:#121a2b; --muted:#6b7280; --txt:#e5e7eb; --primary:#60a5fa; --accent:#34d399; --danger:#f87171; --warn:#fbbf24; --card:#0f172a; --border:#1f2937;
    }
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";color:var(--txt);background:linear-gradient(180deg,#0b1220 0,#0b1220 300px,#0a1020 100%)}
    header{position:sticky;top:0;background:rgba(11,18,32,.75);backdrop-filter:saturate(160%) blur(8px);border-bottom:1px solid var(--border);z-index:50}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{font-size:18px;margin:0 0 8px}
    .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .bar > *{min-height:36px}
    input, select, textarea{background:#0d1628;color:var(--txt);border:1px solid var(--border);border-radius:8px;padding:8px}
    input::placeholder, textarea::placeholder{color:#9aa1ac}
    button{background:#111a2e;color:var(--txt);border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer}
    button.primary{background:linear-gradient(180deg,#2563eb,#1d4ed8);border-color:#1d4ed8}
    button.ghost{background:transparent}
    button.warn{background:#3b2a0a;border-color:#5a3f11;color:#fcd34d}
    button.danger{background:#2a1111;border-color:#512020;color:#fecaca}
    button:disabled{opacity:.5;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:1.2fr .8fr .8fr auto;gap:8px;align-items:center}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
    .muted{color:var(--muted)}
    .inline{display:inline-flex;gap:8px;flex-wrap:wrap;align-items:center}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#0c1526;font-size:12px}
    .tbl{width:100%;border-spacing:0;border-collapse:separate}
    .tbl th,.tbl td{padding:10px 8px;border-bottom:1px solid var(--border);vertical-align:top}
    .tbl th{position:sticky;top:86px;background:rgba(15,23,42,.9);backdrop-filter:blur(6px);text-align:left;z-index:5}
    .row{background:var(--card)}
    .kbd{font:12px/1.2 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#0c1424;padding:2px 6px;border-radius:6px;border:1px solid #182033}
    .badge{display:inline-flex;align-items:center;gap:8px}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
    .pill{border-radius:999px;padding:4px 8px;background:#0e1a2d;border:1px solid #1c2a44}
    .link{color:#a5b4fc;text-decoration:none}
    .link:hover{text-decoration:underline}
    .tools{display:flex;gap:6px;flex-wrap:wrap}
    .tools button{padding:6px 10px;border-radius:8px}
    .footer{color:#9aa1ac;font-size:12px}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.split{grid-template-columns:1fr}}
    .hidden{display:none !important}
    dialog{border:none;border-radius:16px;padding:0;background:#0b1220;color:var(--txt);box-shadow:0 30px 80px rgba(0,0,0,.5);max-width:640px}
    dialog::backdrop{background:rgba(0,0,0,.5)}
    .modal{padding:16px;border:1px solid var(--border)}
    .modal header{position:sticky;top:0;background:#0b1220;border-bottom:1px solid var(--border);padding:12px 16px}
    .modal .body{padding:16px}
    .flex{display:flex;gap:8px;align-items:center}
    .grow{flex:1}
    .right{margin-left:auto}
    .warntext{color:#fbbf24}
    .oktext{color:#86efac}
    .stat{font-size:12px;color:#9aa1ac}
    .sep{height:1px;background:var(--border);margin:8px 0}
    .highlight{background:rgba(96,165,250,.08);border:1px dashed #1d4ed8}
  </style>
  <!-- 使用說明：
    1) 單檔版，上傳到 GitHub Pages 即可用。
    2) 預設存 localStorage；若要跨裝置，使用 ⚙ 設定 綁定 GitHub JSON 並以 PAT 同步。
    3) 此版本已強制用 UTF-8 編碼/解碼 GitHub 內容，避免中文亂碼。
  -->
</head>
<body>
  <header>
    <div class="wrap">
      <h1>🔖 可攜式連結記事簿 <span class="muted">· 單檔版（GitHub Pages OK）</span></h1>
      <div class="bar">
        <input id="q" placeholder="搜尋：描述 / 連結 / 類型 關鍵字" class="grow" />
        <select id="filterType"></select>
        <select id="sorter">
          <option value="updatedAt_desc">更新時間 ⬇︎</option>
          <option value="updatedAt_asc">更新時間 ⬆︎</option>
          <option value="createdAt_desc">建立時間 ⬇︎</option>
          <option value="createdAt_asc">建立時間 ⬆︎</option>
          <option value="type_asc">類型 A→Z</option>
        </select>
        <button id="btnExport">匯出 JSON</button>
        <input id="fileImport" type="file" accept="application/json" class="hidden" />
        <button id="btnImport" class="warn">匯入 JSON</button>
        <button id="btnLoadGH" title="從 GitHub 載入遠端資料">從 GitHub 載入</button>
        <button id="btnSaveGH" class="primary" title="存到 GitHub（提交 JSON 檔）">存到 GitHub</button>
        <button id="btnSettings" class="ghost">⚙ 設定</button>
      </div>
      <div class="stat" id="stat"></div>
    </div>
  </header>

  <main class="wrap" style="margin-top:12px">
    <section class="split">
      <div class="panel">
        <div class="inline" style="margin-bottom:8px">
          <div class="muted">快速新增類型</div>
          <input id="newType" placeholder="輸入新類型名稱（例：文件、教學、工具）" class="grow" />
          <button id="btnAddType">新增類型</button>
        </div>
        <div class="chips" id="typeChips"></div>
      </div>

      <div class="panel">
        <div class="grid">
          <select id="typeSel"></select>
          <input id="desc" placeholder="描述 / 說明" />
          <input id="url" placeholder="https://...（超連結）" />
          <button id="btnAdd" class="primary">加入</button>
        </div>
        <div class="muted" style="margin-top:6px">提示：貼上網址後，按 <span class="kbd">Enter</span> 也可快速加入。</div>
      </div>
    </section>

    <section class="panel" style="margin-top:12px">
      <table class="tbl" id="itemsTbl">
        <thead>
          <tr>
            <th style="width:60px">#</th>
            <th style="width:160px">類型</th>
            <th>描述</th>
            <th style="width:28%">連結</th>
            <th style="width:260px">操作</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>

    <p class="footer">Made with ❤ | 資料預設存於本機瀏覽器（localStorage）。如需跨裝置修改，請用上方「設定」綁定 GitHub JSON 並以 PAT 同步。</p>
  </main>

  <!-- 編輯 Modal -->
  <dialog id="editDlg">
    <div class="modal">
      <header><strong>編輯資料</strong></header>
      <div class="body">
        <div class="grid" style="grid-template-columns:1fr 1fr">
          <label>類型<select id="editType"></select></label>
          <label>變更備註（選填）<input id="editNote" placeholder="例如：修正描述、更新網址"/></label>
        </div>
        <div class="sep"></div>
        <label>描述<textarea id="editDesc" rows="3" placeholder="此連結的用途或備註"></textarea></label>
        <div style="height:8px"></div>
        <label>連結<input id="editUrl" placeholder="https://..."/></label>
      </div>
      <div class="flex" style="padding:12px 16px">
        <span class="muted">會自動寫入變更歷程</span>
        <span class="right"></span>
        <button onclick="closeEdit()">取消</button>
        <button class="primary" id="btnSaveEdit">儲存</button>
      </div>
    </div>
  </dialog>

  <!-- 歷程 Modal -->
  <dialog id="histDlg">
    <div class="modal">
      <header><strong>修改歷程</strong></header>
      <div class="body" id="histBody"></div>
      <div class="flex" style="padding:12px 16px">
        <span class="muted">僅此筆記錄本地或遠端 JSON 內保存</span>
        <span class="right"></span>
        <button onclick="document.getElementById('histDlg').close()">關閉</button>
      </div>
    </div>
  </dialog>

  <!-- 設定 Modal （GitHub 連線） -->
  <dialog id="cfgDlg">
    <div class="modal">
      <header><strong>GitHub 同步設定</strong></header>
      <div class="body">
        <div class="grid" style="grid-template-columns:1fr 1fr; gap:10px">
          <label>Owner（使用者或組織）<input id="ghOwner" placeholder="你的 GitHub 使用者名稱"/></label>
          <label>Repo 名稱<input id="ghRepo" placeholder="你的 repo 名稱"/></label>
          <label>Branch（分支）<input id="ghBranch" value="main"/></label>
          <label>JSON 路徑（於 repo）<input id="ghPath" value="data/links.json"/></label>
        </div>
        <div style="height:10px"></div>
        <label>個人存取權杖 PAT
          <input id="ghToken" placeholder="僅儲存在本機 localStorage" />
        </label>
        <div class="muted" style="margin-top:6px">
          建議建立僅針對該 repo 的 Fine-grained PAT，授予 <span class="kbd">Contents: Read and Write</span> 權限。
          <br/>安全提醒：請勿把 PAT 寫進檔案或提交到 Git。此欄位僅儲存在你的瀏覽器。
        </div>
      </div>
      <div class="flex" style="padding:12px 16px">
        <span id="cfgStat" class="muted"></span>
        <span class="right"></span>
        <button onclick="document.getElementById('cfgDlg').close()">關閉</button>
        <button id="btnSaveCfg">儲存設定</button>
        <button id="btnTestCfg" class="primary">測試連線 / 讀取</button>
      </div>
    </div>
  </dialog>

  <script>
  // ====== 資料模型 ======
  /** @typedef {{ id:string, type:string, desc:string, url:string, createdAt:number, updatedAt:number, history:Array<{ts:number,action:string,note?:string,changes?:Record<string,{from:any,to:any}>}> }} Item */
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const LS_KEY = 'links_db_v1';
  const LS_TYPES = 'links_types_v1';
  const LS_CFG = 'links_cfg_v1';
  let state = /** @type {{ items: Item[], types: string[], ghSha?: string }} */ ({ items: [], types: [] });

  const cfg = loadCfg();

  function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8) }
  function now(){ return Date.now() }

  function saveLocal(){
    localStorage.setItem(LS_KEY, JSON.stringify({ items: state.items }));
    localStorage.setItem(LS_TYPES, JSON.stringify({ types: state.types }));
    setStat(`已儲存於本機 · 總筆數 ${state.items.length}`);
  }
  function loadLocal(){
    const a = localStorage.getItem(LS_KEY);
    const b = localStorage.getItem(LS_TYPES);
    if(a){ try{ state.items = JSON.parse(a).items || [] }catch{ state.items = [] } }
    if(b){ try{ state.types = JSON.parse(b).types || [] }catch{ state.types = [] } }
    if(state.types.length===0){ state.types = ['文件','教學','工具','研究','筆記'] }
  }

  // ====== UI ======
  function setStat(s){ $('#stat').textContent = s }

  function renderTypes(){
    const sel = $('#typeSel'); sel.innerHTML = '';
    state.types.sort((a,b)=>a.localeCompare(b,'zh-Hant'));
    for(const t of state.types){ const o=document.createElement('option'); o.value=o.textContent=t; sel.appendChild(o) }

    const f = $('#filterType'); f.innerHTML = '';
    for(const t of ['全部',...state.types]){ const o=document.createElement('option'); o.value=t; o.textContent=t; f.appendChild(o) }

    const wrap = $('#typeChips'); wrap.innerHTML='';
    state.types.forEach(t=>{
      const d=document.createElement('div'); d.className='chip'; d.textContent=t; wrap.appendChild(d)
    })
  }

  function renderTable(){
    const q = $('#q').value.trim().toLowerCase();
    const ft = $('#filterType').value;
    const sorter = $('#sorter').value;
    const tbody = $('#tbody'); tbody.innerHTML='';

    let rows = state.items.slice();
    if(q){ rows = rows.filter(it => [it.type,it.desc,it.url].join('\n').toLowerCase().includes(q)) }
    if(ft && ft !== '全部'){ rows = rows.filter(it => it.type===ft) }

    const sorters = {
      'updatedAt_desc': (a,b)=> b.updatedAt - a.updatedAt,
      'updatedAt_asc':  (a,b)=> a.updatedAt - b.updatedAt,
      'createdAt_desc': (a,b)=> b.createdAt - a.createdAt,
      'createdAt_asc':  (a,b)=> a.createdAt - b.createdAt,
      'type_asc':       (a,b)=> a.type.localeCompare(b.type,'zh-Hant')
    }
    rows.sort(sorters[sorter]||sorters.updatedAt_desc);

    rows.forEach((it,idx)=>{
      const tr=document.createElement('tr'); tr.className='row';
      const indexCell = `<td class="muted">${idx+1}</td>`;
      const typeCell = `<td><span class="tag" style="background:${typeColor(it.type)}20;border-color:${typeColor(it.type)}66">${it.type}</span><div class="stat">建立：${fmt(it.createdAt)} · 更新：${fmt(it.updatedAt)}</div></td>`;
      const descCell = `<td>${escapeHtml(it.desc||'')}</td>`;
      const linkCell = `<td><a class="link" href="${escapeHtml(it.url)}" target="_blank" rel="noopener">${escapeHtml(it.url)}</a></td>`;
      const toolsCell = document.createElement('td'); toolsCell.className='tools';

      const btnEdit = mkBtn('編輯',()=> openEdit(it.id));
      const btnDel  = mkBtn('刪除',()=> delItem(it.id),'danger');
      const btnCopy = mkBtn('複製連結',()=> copyText(it.url));
      const btnHist = mkBtn('歷程',()=> openHist(it.id));
      toolsCell.append(btnEdit, btnDel, btnCopy, btnHist);

      tr.innerHTML = indexCell + typeCell + descCell + linkCell;
      tr.appendChild(toolsCell);
      tbody.appendChild(tr);
    })

    setStat(`顯示 ${rows.length} / 全部 ${state.items.length} 筆`);
  }

  function mkBtn(text, onClick, cls=''){
    const b=document.createElement('button'); b.textContent=text; if(cls) b.classList.add(cls); b.onclick=onClick; return b
  }

  function typeColor(name){
    let h=0; for(let i=0;i<name.length;i++){ h = (h*31 + name.charCodeAt(i))>>>0 }
    h = h % 360; const s=60, l=52;
    return hslToHex(h,s,l);
  }
  function hslToHex(h, s, l){
    s/=100; l/=100; const k=n=> (n + h/30) % 12;
    const a=s*Math.min(l,1-l);
    const f=n=> l - a*Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n),1)));
    const toHex=x=> ('0'+Math.round(x*255).toString(16)).slice(-2);
    return '#'+toHex(f(0))+toHex(f(8))+toHex(f(4));
  }

  function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])) }
  function fmt(ts){ try{ return new Date(ts).toLocaleString() }catch{ return '' } }

  // ====== CRUD ======
  function addType(){
    const v = $('#newType').value.trim(); if(!v) return;
    if(!state.types.includes(v)){ state.types.push(v); saveLocal(); renderTypes() }
    $('#newType').value='';
  }
  function addItem(){
    const type=$('#typeSel').value.trim();
    const desc=$('#desc').value.trim();
    const url=$('#url').value.trim();
    if(!type||!url){ alert('類型與連結為必填'); return }
    const item={ id:uid(), type, desc, url, createdAt:now(), updatedAt:now(), history:[{ts:now(),action:'create',changes:{type:{to:type},desc:{to:desc},url:{to:url}}}] };
    state.items.unshift(item); saveLocal(); renderTable();
    $('#desc').value=''; $('#url').value=''; $('#url').focus();
  }
  function delItem(id){
    if(!confirm('確定刪除此筆資料？')) return;
    state.items = state.items.filter(x=>x.id!==id); saveLocal(); renderTable();
  }

  let editingId=null;
  function openEdit(id){
    editingId=id; const it=state.items.find(x=>x.id===id); if(!it) return;
    const sel=$('#editType'); sel.innerHTML=''; state.types.forEach(t=>{ const o=document.createElement('option'); o.value=o.textContent=t; sel.appendChild(o) }); sel.value=it.type;
    $('#editDesc').value=it.desc; $('#editUrl').value=it.url; $('#editNote').value='';
    $('#editDlg').showModal();
  }
  function closeEdit(){ $('#editDlg').close(); editingId=null }

  async function saveEdit(){
    const it=state.items.find(x=>x.id===editingId); if(!it) return;
    const nType=$('#editType').value.trim();
    const nDesc=$('#editDesc').value.trim();
    const nUrl =$('#editUrl').value.trim();
    const note =$('#editNote').value.trim();

    const changes={};
    if(it.type!==nType) changes.type={from:it.type,to:nType};
    if(it.desc!==nDesc) changes.desc={from:it.desc,to:nDesc};
    if(it.url !==nUrl)  changes.url ={from:it.url ,to:nUrl };

    it.type=nType; it.desc=nDesc; it.url=nUrl; it.updatedAt=now();
    it.history.push({ts:now(),action:'edit',note,changes:Object.keys(changes).length?changes:undefined});

    saveLocal(); renderTable(); closeEdit();
  }

  function openHist(id){
    const it=state.items.find(x=>x.id===id); if(!it) return;
    const box=$('#histBody'); box.innerHTML='';
    if(!it.history?.length){ box.innerHTML='<div class="muted">尚無歷程</div>' }
    else{
      it.history.slice().reverse().forEach(h=>{
        const d=document.createElement('div'); d.className='pill'; d.style.marginBottom='8px'; d.style.borderColor='#263248';
        const title = `<div><strong>${h.action.toUpperCase()}</strong> · <span class="muted">${fmt(h.ts)}</span>${h.note?` · <span class="warntext">${escapeHtml(h.note)}</span>`:''}</div>`;
        let diff='';
        if(h.changes){ diff='<ul style="margin:6px 0 0 18px">' + Object.entries(h.changes).map(([k,v])=>`<li><span class="muted">${k}</span>：${escapeHtml(String(v.from||''))} → <span class="oktext">${escapeHtml(String(v.to||''))}</span></li>`).join('') + '</ul>' }
        d.innerHTML=title+diff; box.appendChild(d);
      })
    }
    $('#histDlg').showModal();
  }

  async function copyText(t){ try{ await navigator.clipboard.writeText(t); setStat('已複製到剪貼簿') }catch{ alert('瀏覽器不支援自動複製，請手動選取') } }

  // ====== 匯出 / 匯入 ======
  function exportJSON(){
    const payload = { version:1, exportedAt:now(), types:state.types, items:state.items };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=`links_db_${new Date().toISOString().replace(/[:T]/g,'-').slice(0,19)}.json`;
    a.click(); URL.revokeObjectURL(a.href);
    setStat('已匯出 JSON 檔');
  }
  function importJSON(file){
    const reader=new FileReader(); reader.onload=e=>{
      try{
        const data=JSON.parse(String(e.target.result||'{}'));
        if(!data || !Array.isArray(data.items)) throw new Error('格式不正確');
        state.items = data.items; state.types = Array.isArray(data.types) ? data.types : state.types;
        saveLocal(); renderTypes(); renderTable(); setStat('已匯入 JSON 並覆蓋現有資料');
      }catch(err){ alert('匯入失敗：'+err.message) }
    }; reader.readAsText(file, 'utf-8');
  }

  // ====== GitHub 連線（UTF-8 強制） ======
  function loadCfg(){ try{ return JSON.parse(localStorage.getItem(LS_CFG)||'{}') }catch{ return {} } }
  function saveCfg(v){ localStorage.setItem(LS_CFG, JSON.stringify(v||{})) }

  function openCfg(){
    $('#ghOwner').value = cfg.owner||'';
    $('#ghRepo').value  = cfg.repo||'';
    $('#ghBranch').value= cfg.branch||'main';
    $('#ghPath').value  = cfg.path||'data/links.json';
    $('#ghToken').value = cfg.token||'';
    $('#cfgStat').textContent='';
    $('#cfgDlg').showModal();
  }

  function ghHeaders(){
    const h={ 'Accept':'application/vnd.github+json' };
    if(cfg.token) h['Authorization'] = `Bearer ${cfg.token}`;
    return h;
  }

  function b64EncodeUTF8(str){ return btoa(unescape(encodeURIComponent(str))) }
  function b64DecodeUTF8(b64){ try{ return decodeURIComponent(escape(atob(b64))) }catch(e){ console.warn('Fallback base64 decode', e); return atob(b64) } }

  async function ghLoad(){
    if(!cfg.owner||!cfg.repo||!cfg.path){ alert('請先到設定填寫 owner/repo/path'); return }
    setStat('從 GitHub 讀取中…');
    const url=`https://api.github.com/repos/${encodeURIComponent(cfg.owner)}/${encodeURIComponent(cfg.repo)}/contents/${encodeURIComponent(cfg.path)}?ref=${encodeURIComponent(cfg.branch||'main')}`;
    const res=await fetch(url,{headers:ghHeaders()});
    if(res.status===404){ if(confirm('遠端檔案不存在，要建立一個新的嗎？（之後請按「存到 GitHub」）')){ state.items=[]; saveLocal(); renderTable(); return } else { setStat('已取消'); return } }
    if(!res.ok){ const t=await res.text(); alert('讀取失敗：'+res.status+'\n'+t); return }
    const json=await res.json();
    state.ghSha = json.sha; // 存下次 PUT 用
    const content = b64DecodeUTF8(json.content||'');
    const data = JSON.parse(content||'{}');
    if(!data || !Array.isArray(data.items)) throw new Error('遠端 JSON 格式不正確');
    state.items = data.items; state.types = Array.isArray(data.types)?data.types:state.types;
    saveLocal(); renderTypes(); renderTable();
    setStat(`已從 GitHub 載入（${cfg.owner}/${cfg.repo}:${cfg.branch||'main'} · ${cfg.path}）`);
  }

  async function ghSave(){
    if(!cfg.owner||!cfg.repo||!cfg.path||!cfg.token){ alert('請先到設定填寫 owner/repo/path 與 PAT'); return }
    setStat('上傳至 GitHub…');
    if(!state.ghSha){ try{ await ghLoad() }catch{ /* 忽略 */ } }

    const payload = { version:1, updatedAt:now(), types:state.types, items:state.items };
    const content = b64EncodeUTF8(JSON.stringify(payload,null,2));
    const url=`https://api.github.com/repos/${encodeURIComponent(cfg.owner)}/${encodeURIComponent(cfg.repo)}/contents/${encodeURIComponent(cfg.path)}`;
    const body={ message:`chore: update links.json @ ${new Date().toISOString()}`, content, branch: cfg.branch||'main', sha: state.ghSha };
    const res=await fetch(url,{ method:'PUT', headers:{...ghHeaders(),'Content-Type':'application/json'}, body:JSON.stringify(body) });
    if(!res.ok){ const t=await res.text(); alert('儲存失敗：'+res.status+'\n'+t); return }
    const out=await res.json(); state.ghSha = out.content?.sha || undefined;
    setStat('已提交至 GitHub ✅');
  }

  // ====== 事件綁定 ======
  function bind(){
    $('#btnAddType').onclick=addType;
    $('#btnAdd').onclick=addItem;
    $('#url').addEventListener('keydown', e=>{ if(e.key==='Enter') addItem() });
    $('#q').oninput=renderTable; $('#filterType').onchange=renderTable; $('#sorter').onchange=renderTable;

    $('#btnExport').onclick=exportJSON;
    $('#btnImport').onclick=()=> $('#fileImport').click();
    $('#fileImport').onchange=(e)=>{ const f=e.target.files?.[0]; if(f) importJSON(f) };

    $('#btnLoadGH').onclick=ghLoad; $('#btnSaveGH').onclick=ghSave;
    $('#btnSettings').onclick=openCfg; $('#btnSaveCfg').onclick=()=>{
      cfg.owner=$('#ghOwner').value.trim();
      cfg.repo=$('#ghRepo').value.trim();
      cfg.branch=$('#ghBranch').value.trim()||'main';
      cfg.path=$('#ghPath').value.trim()||'data/links.json';
      cfg.token=$('#ghToken').value.trim();
      saveCfg(cfg); $('#cfgStat').textContent='已儲存設定（僅存於本機）';
    };
    $('#btnTestCfg').onclick=async()=>{ try{ await ghLoad(); $('#cfgStat').textContent='讀取成功'; }catch(err){ $('#cfgStat').textContent='讀取失敗：'+err.message } };

    $('#btnSaveEdit').onclick=saveEdit;
  }

  // ====== 啟動 ======
  loadLocal(); renderTypes(); renderTable(); bind();
    
  <!-- ====== 附加修補：UTF-8 強化 + 亂碼修復工具（2025-08-30） ====== -->
  <script>
  (function(){
    try{
      // 1) 在工具列動態加入「修復亂碼」「清除本機」按鈕
      const bar = document.querySelector('.bar');
      if(bar && !document.getElementById('btnFixMJB')){
        const fix = document.createElement('button'); fix.id='btnFixMJB'; fix.textContent='修復亂碼'; fix.title='嘗試修復已存資料的亂碼（不會影響 GitHub 上的檔案）';
        const clr = document.createElement('button'); clr.id='btnClearLocal'; clr.textContent='清除本機資料'; clr.className='danger'; clr.title='刪除本機 localStorage 資料（不影響 GitHub 上的 JSON）';
        bar.insertBefore(fix, bar.querySelector('#btnLoadGH'));
        bar.insertBefore(clr, bar.querySelector('#btnSettings'));
      }

      // 2) 更穩定的 Base64 ⇄ UTF-8 轉換
      const textEncoder = new TextEncoder();
      const textDecoder = new TextDecoder('utf-8');
      function b64fromBytes(bytes){ let s=''; bytes.forEach(b=> s += String.fromCharCode(b)); return btoa(s) }
      function bytesFromB64(b64){ const bin=atob(b64||''); const len=bin.length; const arr=new Uint8Array(len); for(let i=0;i<len;i++) arr[i]=bin.charCodeAt(i); return arr }
      function b64EncodeUTF8(str){ return b64fromBytes(textEncoder.encode(str)) }
      function b64DecodeUTF8(b64){ return textDecoder.decode(bytesFromB64(b64)) }

      // 3) 亂碼偵測/修復
      function isMostlyCJK(s){ if(!s) return false; let c=0; for(const ch of s){ const x=ch.charCodeAt(0); if((x>=0x4E00&&x<=0x9FFF)||(x>=0x3400&&x<=0x4DBF)||(x>=0x3040&&x<=0x30FF)) c++; } return c && (c/s.length>0.3) }
      function looksMojibake(s){ return /Ã|Â|å|æ|ç|é|è|ä|ö/.test(s||'') && !isMostlyCJK(s) }
      function fixMaybeMojibake(s){ if(!s) return s; try{ if(looksMojibake(s)){ const a=decodeURIComponent(escape(s)); if(isMostlyCJK(a)) return a; const b=unescape(encodeURIComponent(s)); if(isMostlyCJK(b)) return b; } }catch{} return s }
      function sanitizeItem(it){ return { ...it, type:fixMaybeMojibake(it.type), desc:fixMaybeMojibake(it.desc) } }
      window.__fixAllMojibake = function(){
        try{
          const LS_KEY = 'links_db_v1', LS_TYPES='links_types_v1';
          let changed=0;
          let items=[], types=[];
          try{ items = JSON.parse(localStorage.getItem(LS_KEY)||'{}').items||[] }catch{}
          try{ types = JSON.parse(localStorage.getItem(LS_TYPES)||'{}').types||[] }catch{}
          items = items.map(it=>{ const n=sanitizeItem(it); if(n.type!==it.type||n.desc!==it.desc) changed++; return n });
          types = types.map(t=>{ const nt=fixMaybeMojibake(t); if(nt!==t) changed++; return nt });
          localStorage.setItem(LS_KEY, JSON.stringify({items}));
          localStorage.setItem(LS_TYPES, JSON.stringify({types}));
          if(window.renderTypes) window.renderTypes(); if(window.renderTable) window.renderTable();
          alert(changed?`已修復 ${changed} 處疑似亂碼並儲存。`:'未發現需要修復的內容。');
        }catch(e){ alert('修復失敗：'+e.message) }
      }

      // 綁定兩個新按鈕
      const fixBtn = document.getElementById('btnFixMJB'); if(fixBtn) fixBtn.onclick=window.__fixAllMojibake;
      const clrBtn = document.getElementById('btnClearLocal'); if(clrBtn) clrBtn.onclick=()=>{ if(confirm('確定清除本機資料？（不會影響 GitHub 上的 JSON）')){ localStorage.removeItem('links_db_v1'); localStorage.removeItem('links_types_v1'); if(window.renderTypes) window.renderTypes(); if(window.renderTable) window.renderTable(); alert('已清除本機資料'); } };

      // 4) 以 UTF-8 重新定義 ghLoad/ghSave（覆寫舊版本）
      const LS_CFG='links_cfg_v1';
      function cfg(){ try{ return JSON.parse(localStorage.getItem(LS_CFG)||'{}') }catch{ return {} } }
      function ghHeaders(){ const c=cfg(); const h={'Accept':'application/vnd.github+json'}; if(c.token) h['Authorization']=`Bearer ${c.token}`; return h }
      window.ghLoad = async function(){
        const c=cfg();
        if(!c.owner||!c.repo||!c.path){ alert('請先到設定填寫 owner/repo/path'); return }
        if(window.setStat) setStat('從 GitHub 讀取中…');
        const url=`https://api.github.com/repos/${encodeURIComponent(c.owner)}/${encodeURIComponent(c.repo)}/contents/${encodeURIComponent(c.path)}?ref=${encodeURIComponent(c.branch||'main')}`;
        const res=await fetch(url,{headers:ghHeaders()});
        if(res.status===404){ if(confirm('遠端檔案不存在，要建立一個新的嗎？（之後請按「存到 GitHub」）')){ localStorage.setItem('links_db_v1', JSON.stringify({items:[]})); if(window.renderTable) renderTable(); return } else { if(window.setStat) setStat('已取消'); return } }
        if(!res.ok){ const t=await res.text(); alert('讀取失敗：'+res.status+'
'+t); return }
        const json=await res.json();
        const content = b64DecodeUTF8(json.content||'');
        const data = JSON.parse(content||'{}');
        if(!data || !Array.isArray(data.items)) throw new Error('遠端 JSON 格式不正確');
        localStorage.setItem('links_db_v1', JSON.stringify({items:data.items.map(sanitizeItem)}));
        if(Array.isArray(data.types)) localStorage.setItem('links_types_v1', JSON.stringify({types:data.types.map(fixMaybeMojibake)}));
        if(window.renderTypes) renderTypes(); if(window.renderTable) renderTable(); if(window.setStat) setStat('已從 GitHub 載入（UTF-8）');
        window.state = window.state || {}; window.state.ghSha = json.sha;
      }
      window.ghSave = async function(){
        const c=cfg();
        if(!c.owner||!c.repo||!c.path||!c.token){ alert('請先到設定填寫 owner/repo/path 與 PAT'); return }
        if(window.setStat) setStat('上傳至 GitHub…');
        try{ if(!window.state||!window.state.ghSha) await window.ghLoad() }catch{}
        let items=[], types=[]; try{ items=JSON.parse(localStorage.getItem('links_db_v1')||'{}').items||[] }catch{}; try{ types=JSON.parse(localStorage.getItem('links_types_v1')||'{}').types||[] }catch{};
        const payload={ version:1, updatedAt:Date.now(), types, items };
        const content=b64EncodeUTF8(JSON.stringify(payload,null,2));
        const url=`https://api.github.com/repos/${encodeURIComponent(c.owner)}/${encodeURIComponent(c.repo)}/contents/${encodeURIComponent(c.path)}`;
        const body={ message:`chore: update links.json @ ${new Date().toISOString()}`, content, branch:c.branch||'main', sha:(window.state&&window.state.ghSha) };
        const res=await fetch(url,{ method:'PUT', headers:{...ghHeaders(),'Content-Type':'application/json'}, body:JSON.stringify(body) });
        if(!res.ok){ const t=await res.text(); alert('儲存失敗：'+res.status+'
'+t); return }
        const out=await res.json(); window.state = window.state || {}; window.state.ghSha = out.content?.sha; if(window.setStat) setStat('已提交至 GitHub ✅（UTF-8）');
      }
    }catch(e){ console.error('修補區塊錯誤：', e) }
  })();
  </script>
</script>
</body>
</html>
